<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Tabela Operacional</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* UI geral */
    ::-webkit-scrollbar { height: 8px; width: 8px; }
    ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 8px; }
    thead th { position: sticky; top: 0; background: #f3f4f6; z-index: 2; box-shadow: 0 1px 0 #e5e7eb; }

    /* Chips de respons√°veis (multi-select visual) */
    .tag {
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      padding: .22rem .55rem;
      border-radius: 12px;
      font-size: .72rem;
      font-weight: 700;
      line-height: 1;
      background: #eff6ff;
      color: #1e40af;
      border: 1px solid #bfdbfe;
    }



    .tag button {
      border: 0;
      background: transparent;
      cursor: pointer;
      font-weight: 800;
      line-height: 1;
      color: #1e40af;
    }



    .tag button:hover { color: #0b3ea8; }
    .select-mini { padding: .25rem .5rem; border: 1px solid #e5e7eb; border-radius: .5rem; background: #fff; }

    /* Datas coloridas */
    input.date-inicio { background: #fee2e2; border-color: #ef4444; }
    input.date-inicio:focus { outline: 1; box-shadow: 0 0 0 2px #fecaca; }
    input.date-fim { background: #dcfce7; border-color: #22c55e; }
    input.date-fim:focus { outline: 1; box-shadow: 0 0 0 2px #bbf7d0; }

    /* Estilo dos campos de Treinamento */
    input.treinamento {
      transition: background 0.2s, border 0.2s;
    }

    input.treinamento.pendente {
      background-color: #fef9c3; /* amarelo claro */
      border-color: #facc15; /* borda amarela */
    }

    input.treinamento.ok {
      background-color: #dcfce7; /* verde claro */
      border-color: #22c55e; /* borda verde */
    }

    /* Responsividade */
    .container {
      width: 100%;
    }

    .table-responsive {
      max-width: 100%;
      overflow-x: auto;
    }

    /* Ajusta as colunas na tabela para telas pequenas */
    @media (max-width: 768px) {
      th, td {
        display: block;
        width: 100%;
        padding: 1rem;
        text-align: left;
      }

      .table-wrapper {
        display: block;
        overflow-x: auto;
        max-width: 100%;
      }
    }

    /* Tamanho ajustado do gr√°fico */
    #treinamentoChart {
      max-width: 400px; /* Largura m√°xima */
      max-height: 400px; /* Altura m√°xima */
      width: 100%; /* Adapte a largura para 100% da tela dispon√≠vel */
      height: auto; /* Mant√©m a propor√ß√£o do gr√°fico */
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <header class="px-6 py-4 border-b bg-white text-center">
    <h1 class="text-2xl font-bold inline-flex items-center justify-center">
      <img src="logo%20callmed%201.PNG" alt="√çcone" class="mr-2 w-100 h-20">Tabela Treinamentos
    </h1>
  </header>

  <main class="max-w-7xl mx-auto mt-6">
    <!-- Barra de navega√ß√£o -->
    <div class="flex mb-3">
      <button id="tabPrincipal" class="px-3 py-1 border rounded-lg hover:bg-gray-100">Aba Principal</button>
      <button id="tabDashboard" class="px-3 py-1 border rounded-lg hover:bg-gray-100 ml-2">Dashboard</button>
    </div>

    <!-- Aba Principal -->
    <div id="tabPrincipalContent">
      <div class="flex flex-wrap gap-2 mb-3">
        <button id="addRow" class="px-3 py-1 border rounded-lg hover:bg-gray-100">Nova linha</button>
        <button id="exp" class="px-3 py-1 border rounded-lg hover:bg-gray-100">Exportar CSV</button>
        <label class="px-3 py-1 border rounded-lg hover:bg-gray-100 cursor-pointer">Importar CSV
          <input id="imp" type="file" accept=".csv" hidden>
        </label>
        <button id="clr" class="px-3 py-1 border rounded-lg text-red-600 hover:bg-red-50">Apagar Tudo</button>
      </div>

      <div class="table-responsive overflow-x-auto bg-white rounded-2xl shadow">
        <table class="min-w-full border-collapse text-sm">
          <thead>
            <tr id="thead" class="bg-gray-100"></tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <p class="text-xs text-gray-500 mt-2 px-1">
        Dica: os campos de texto s√£o edit√°veis, ‚ÄúRespons√°veis‚Äù tem chips (), e as datas t√™m cores por tipo.
        Tudo √© salvo automaticamente no seu navegador.
      </p>
    </div>

    <!-- Aba Dashboard (escondida inicialmente) -->
    <div id="tabDashboardContent" class="hidden bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-xl font-semibold mb-4">Dashboard</h2>
      <div>
        <p><strong>Treinamentos OK: <span id="treinamentoOk"></span>%</strong></p>
        <p><strong>Treinamentos Pendentes: <span id="treinamentoPendente"></span>%</strong></p>
        <canvas id="treinamentoChart" width="300" height="300"></canvas>
      </div>
      <!-- Bot√£o para atualizar gr√°fico -->
      <button id="updateChartButton" class="px-3 py-1 border rounded-lg hover:bg-gray-100 mt-4">Atualizar Gr√°fico</button>
    </div>
  </main>

  <script>
    const STORAGE = 'tabela_operacional_v3';
    let chartInstance = null; // Vari√°vel para armazenar o gr√°fico

    let columns = [
      { key: 'unidade', label: 'Unidade', type: 'select', width: 80, options: 'Centro de Sa√∫de Moacyr Santos, Cl√≠nica do Idoso, UPA Barra, HPMS - Hospital Serra, Unidade Mista Sana, Cl√≠nica do Autista, Casa da Crian√ßa e do Adolescente, UBS Novo Cavaleiros, ESF Aroeira, Pronto Socorro Imbetiba, UPA Lagomar, ESF Bosque Azul, ESF Malvinas AC, UBS Lagomar, ESF Glic√©rio, Pronto Socorro Aeroporto, Unidade Mista C√≥rrego do Ouro' },
      { key: 'tipo', label: 'Tipo de Unidade', type: 'select', width: 90, options: 'UBS,UPA,Hospital' },
      { key: 'dtinicio', label: 'Data In√≠cio', type: 'date', width: 120 },
      { key: 'dtfim', label: 'Data Fim', type: 'date', width: 120 },
      { key: 'treinamento', label: 'Treinamento', type: 'select', width: 40, options: 'Ok,Pendente' },
      { key: 'resp', label: 'Respons√°veis', type: 'select', width: 100, options: 'Alan,Marcelo,Maclaud,Aline,Rachel,Callmed' },
      { key: 'acompanhamento', label: 'Acompanhamento', type: 'select', width: 10, options: 'Realizado, N√£o Realizado' },
      { key: 'acoes', label: 'A√ß√µes', type: 'actions', width: 80 }
    ];

    let rows = JSON.parse(localStorage.getItem(STORAGE) || '[]');
    if (!rows.length) {
      rows = [];
      persist();
    }

    function persist() { localStorage.setItem(STORAGE, JSON.stringify(rows)); }
    function tdBase(w) { const td = document.createElement('td'); td.className = 'border-t'; td.style.minWidth = w + 'px'; return td; }

    function renderHead() {
      const tr = document.getElementById('thead');
      tr.innerHTML = '';
      columns.forEach(c => {
        const th = document.createElement('th');
        th.textContent = c.label;
        th.className = 'p-2 text-left font-semibold text-center';
        th.style.minWidth = (c.width || 140) + 'px';
        tr.appendChild(th);
      });
    }

    function renderRows() {
      const tb = document.getElementById('tbody');
      tb.innerHTML = '';

      rows.forEach((row, i) => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';

        columns.forEach(col => {
          const td = tdBase(col.width);
          td.classList.add('text-center');

          if (col.type === 'text') {
            const inp = document.createElement('input');
            inp.className = 'px-2 py-1 border rounded-lg w-full';
            inp.value = row[col.key] || '';
            inp.oninput = () => { row[col.key] = inp.value; persist(); updateDashboard(); };
            td.appendChild(inp);
          } else if (col.type === 'date') {
            const inp = document.createElement('input');
            inp.type = 'date';
            inp.className = 'px-2 py-1 border rounded-lg w-full';
            inp.value = row[col.key] || '';
            inp.oninput = () => { row[col.key] = inp.value; persist(); updateDashboard(); };
            td.appendChild(inp);
          } else if (col.type === 'select') {
            const sel = document.createElement('select');
            sel.className = 'px-2 py-1 border rounded-lg bg-white w-full';
            (col.options || '').split(',').map(s => s.trim()).filter(Boolean).forEach(o => {
              const op = document.createElement('option');
              op.value = o;
              op.textContent = o;
              sel.appendChild(op);
            });
            sel.value = row[col.key] || '';
            sel.onchange = () => { row[col.key] = sel.value; persist(); updateDashboard(); };
            td.appendChild(sel);
          } else if (col.type === 'actions') {
            const btn = document.createElement('button');
            btn.innerHTML = 'üóëÔ∏è';
            btn.title = 'Excluir linha';
            btn.className = 'px-2 py-1 rounded-lg border hover:bg-red-50 hover:text-red-600';
            btn.onclick = () => {
              const senha = prompt("Digite a senha para excluir esta linha:");
              if (senha === "1") {
                if (confirm('Tem certeza que deseja excluir esta linha?')) {
                  rows.splice(i, 1);
                  persist();
                  renderRows();
                }
              } else {
                alert("Senha incorreta!");
              }
            };
            td.appendChild(btn);
          }

          tr.appendChild(td);
        });

        tb.appendChild(tr);
      });

      updateDashboard(); // Atualiza o dashboard sempre que a tabela for renderizada
    }

    // Fun√ß√£o para calcular o percentual de "Ok" e "Pendente"
    function updateDashboard() {
      const treinamentoOk = rows.filter(row => row.treinamento === "Ok").length;
      const treinamentoPendente = rows.filter(row => row.treinamento === "Pendente").length;

      const total = rows.length;
      const percentualOk = total === 0 ? 0 : (treinamentoOk / total) * 100;
      const percentualPendente = total === 0 ? 0 : (treinamentoPendente / total) * 100;

      document.getElementById("treinamentoOk").textContent = percentualOk.toFixed(2);
      document.getElementById("treinamentoPendente").textContent = percentualPendente.toFixed(2);
      updateChart(percentualOk, percentualPendente); // Atualiza o gr√°fico
    }

    // Fun√ß√£o para atualizar o gr√°fico
    function updateChart(treinamentoOk, treinamentoPendente) {
      const ctx = document.getElementById('treinamentoChart').getContext('2d');

      // Se j√° houver um gr√°fico, destrua-o antes de criar um novo
      if (chartInstance) {
        chartInstance.destroy();
      }

      chartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Treinamentos Ok', 'Treinamentos Pendentes'],
          datasets: [{
            data: [treinamentoOk, treinamentoPendente],
            backgroundColor: ['#4CAF50', '#FFEB3B'],
            borderColor: ['#388E3C', '#FBC02D'],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                label: function(tooltipItem) {
                  return tooltipItem.label + ': ' + tooltipItem.raw.toFixed(2) + '%';
                }
              }
            }
          }
        }
      });
    }

    // Mostrar a se√ß√£o do dashboard
    document.getElementById('tabDashboard').onclick = () => {
      const dashboardSection = document.getElementById("tabDashboardContent");
      dashboardSection.classList.toggle("hidden");
      updateDashboard(); // Atualiza as informa√ß√µes do dashboard
    };

    document.getElementById('addRow').onclick = () => { rows.push({}); persist(); renderRows(); };

    /* ===== Start ===== */
    renderHead(); renderRows();
  </script>
</body>
</html>
