<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEEDS - Controle Operacional v4.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Estilo b√°sico para a tabela e elementos */
        .select-mini {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem; /* Texto menor */
            height: 1.75rem; /* Altura reduzida */
        }
        .table-container {
            max-width: 100%;
            overflow-x: auto;
        }
        #dataTable th, #dataTable td {
            white-space: nowrap; /* Previne quebra de linha em c√©lulas */
        }
        /* Corrigindo o layout do card para evitar sobreposi√ß√£o */
        .dashboard-card-content {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .dashboard-chart-area {
            position: relative;
            width: 150px; /* Tamanho fixo para o gr√°fico */
            height: 150px;
            margin-bottom: 1rem;
        }
        .dashboard-chart-center {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .dashboard-stats-list {
            width: 100%;
            padding: 0 0.5rem; /* Padding para as listas de status */
        }
        /* Estilos do Calend√°rio Mensal */
        .calendar-month-container {
            width: 100%;
            overflow-x: auto;
        }
        .calendar-month-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .calendar-weekday-header {
            background-color: #3B82F6;
            color: white;
            font-weight: 600;
            padding: 0.75rem;
            text-align: center;
            border: 1px solid #2563EB;
            font-size: 0.875rem;
        }
        .calendar-week-row {
            border-bottom: 1px solid #E5E7EB;
        }
        .calendar-day-cell-empty {
            background-color: #F9FAFB;
            border: 1px solid #E5E7EB;
            min-height: 100px;
            height: 100px;
        }
        .calendar-day-cell-month {
            border: 1px solid #E5E7EB;
            min-height: 100px;
            height: 100px;
            vertical-align: top;
            padding: 0.5rem;
            background-color: white;
            position: relative;
        }
        .calendar-day-number {
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }
        .calendar-day-events {
            display: flex;
            flex-direction: column; /* Para empilhar os nomes das unidades */
            gap: 0.1rem; /* Espa√ßamento menor entre os badges */
            margin-top: 0.25rem;
        }
        .calendar-event-badge {
            padding: 0.1rem 0.25rem; /* Padding menor */
            border-radius: 4px;
            font-size: 0.65rem; /* Fonte menor para caber o nome */
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: block; /* Ocupar a largura total da c√©lula */
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis; /* Para cortar nomes longos */
        }
        .calendar-event-badge:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

    </style>
</head>
<body class="bg-blue-50 font-sans">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <div class="bg-white shadow-xl rounded-xl p-4 mb-6 border border-blue-200">

            <div class="flex items-center mb-4">
                <img src="logo%20callmed%201.PNG" alt="Logo da Empresa" class="h-20 mr-4">
                <div>
                    <h1 class="text-3xl font-bold text-indigo-700 mb-0">MEEDS - Controle Operacional</h1>
                    <p class="text-gray-600">Monitoramento de Processos Operacionais por Unidade.</p>
                </div>
            </div>

            <div class="flex flex-wrap gap-3 justify-between items-center mt-4 border-t pt-4 border-gray-200">

                <div class="flex gap-3">
                    <button id="addRow" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150 flex items-center text-sm">
                        + Nova Linha
                    </button>
                    <button id="clr" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150 flex items-center text-sm">
                        Limpar Tudo üóëÔ∏è
                    </button>
                </div>


                <div class="relative inline-block text-left">
                    <div>
                        <button type="button" id="downloadButton" class="inline-flex justify-center w-full rounded-md border border-yellow-400 shadow-sm px-4 py-2 bg-yellow-400 text-sm font-medium text-gray-900 hover:bg-yellow-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">

                            Exportar Dados
                            <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>

                    <div id="downloadMenu" class="hidden origin-top-right absolute right-0 mt-2 w-40 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-10" role="menu" aria-orientation="vertical" aria-labelledby="menu-button" tabindex="-1">
                        <div class="py-1" role="none">
                            <a href="#" id="exportCsvBtn" class="text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem" tabindex="-1">CSV (V√≠rgula)</a>
                            <a href="#" id="exportXlsBtn" class="text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem" tabindex="-1">Excel (Ponto e V√≠rgula)</a>
                            <a href="#" id="exportPdfBtn" class="text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem" tabindex="-1">PDF</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-5 pt-4 border-t border-gray-200">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Filtros R√°pidos:</h3>
                <div class="flex flex-wrap gap-4 mb-3 items-end">

                    <div>
                        <label for="filterTreinamento" class="text-sm block">Treinamento:</label>
                        <select id="filterTreinamento" class="select-mini border rounded-lg border-blue-200">
                            <option value="">Todos</option>
                        </select>
                    </div>

                    <div>
                        <label for="filterResp" class="text-sm block">Respons√°veis:</label>
                        <select id="filterResp" class="select-mini border rounded-lg border-blue-200">
                            <option value="">Todos</option>
                        </select>
                    </div>

                    <div>
                        <label for="filterFinalizada" class="text-sm block">Finalizada:</label>
                        <select id="filterFinalizada" class="select-mini border rounded-lg border-blue-200">
                            <option value="">Todos</option>
                        </select>
                    </div>

                    <button id="clearFilters" class="bg-blue-100 hover:bg-blue-200 text-blue-700 text-sm font-bold py-1.5 px-3 rounded-lg transition duration-150 mt-3 sm:mt-0 border border-blue-300">
                        Limpar Filtros
                    </button>
                </div>
            </div>
        </div>

        <div class="flex border-b border-gray-200 mb-4">
            <button id="tabPrincipal" class="py-2 px-4 -mb-px text-sm text-blue-800 border-t border-l border-r rounded-t-lg transition duration-150 bg-blue-100 hover:bg-blue-200 font-semibold"> Tabela de Processos
            </button>
            <button id="tabDashboard" class="py-2 px-4 -mb-px text-sm border-t border-l border-r rounded-t-lg transition duration-150 bg-indigo-600 text-white shadow-md"> Dashboard de Status
            </button>
            <button id="tabCalendario" class="py-2 px-4 -mb-px text-sm border-t border-l border-r rounded-t-lg transition duration-150 bg-gray-100 text-gray-700 hover:bg-gray-200"> Calend√°rio
            </button>
        </div>


        <div class="bg-white shadow-xl rounded-xl p-6 border border-blue-200">

            <div id="tabPrincipalContent">
                <div class="table-container shadow-md rounded-lg border border-blue-200">
                    <table class="min-w-full divide-y divide-gray-200" id="dataTable">
                        <thead class="bg-blue-50">
                            <tr id="thead">
                                </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="tbody">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="tabDashboardContent" class="hidden">
                <h2 class="text-2xl font-bold text-indigo-700 mb-6">Vis√£o Geral dos Processos</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

                    <div class="bg-white p-4 rounded-xl shadow-lg border border-blue-200">
                        <h3 class="text-lg font-bold text-gray-700 mb-4 text-center">Progresso Treinamento</h3>
                        <div class="dashboard-card-content w-full">
                            <div class="dashboard-chart-area">
                                <canvas id="progressTreinamentoChart"></canvas>
                                <div class="dashboard-chart-center">
                                    <span class="text-xl font-bold text-gray-800" id="progressTreinamentoCountTotal">0</span>
                                    <span class="text-xs text-gray-500">Total</span>
                                </div>
                            </div>
                            <div class="dashboard-stats-list mt-3 space-y-1 text-sm">
                                <p class="flex justify-between text-blue-600 items-center">
                                    <span class="flex items-center">üü¶ Em Andamento:</span>
                                    <span><span id="progressTreinamentoPercentAndamento">0.00</span>%</span>
                                </p>
                                <p class="flex justify-between text-green-600 items-center">
                                    <span class="flex items-center">‚úÖ Conclu√≠do (Ok):</span>
                                    <span><span id="progressTreinamentoPercentOk">0.00</span>% (<span id="progressTreinamentoCountOk">0</span>)</span>
                                </p>
                                <p class="flex justify-between text-yellow-600 items-center">
                                    <span class="flex items-center">‚ö†Ô∏è Pendente:</span>
                                    <span><span id="progressTreinamentoPercentPendente">0.00</span>%</span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-lg border border-blue-200">
                        <h3 class="text-lg font-bold text-gray-700 mb-4 text-center">Progresso Acompanhamento</h3>
                        <div class="dashboard-card-content w-full">
                            <div class="dashboard-chart-area">
                                <canvas id="progressAcompanhamentoChart"></canvas>
                                <div class="dashboard-chart-center">
                                    <span class="text-xl font-bold text-gray-800" id="progressAcompanhamentoCountTotal">0</span>
                                    <span class="text-xs text-gray-500">Total</span>
                                </div>
                            </div>
                            <div class="dashboard-stats-list mt-3 space-y-1 text-sm">
                                <p class="flex justify-between text-yellow-600 items-center">
                                    <span class="flex items-center">üü° Realizado:</span>
                                    <span><span id="progressAcompanhamentoPercentRealizado">0.00</span>% (<span id="progressAcompanhamentoCountRealizado">0</span>)</span>
                                </p>
                                <p class="flex justify-between text-red-600 items-center">
                                    <span class="flex items-center">üî¥ N√£o Realizado:</span>
                                    <span><span id="progressAcompanhamentoPercentNaoRealizado">0.00</span>%</span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-lg border border-blue-200">
                        <h3 class="text-lg font-bold text-gray-700 mb-4 text-center">Status Finalizado</h3>
                        <div class="dashboard-card-content w-full">
                            <div class="dashboard-chart-area">
                                <canvas id="progressFinalizadaChart"></canvas>
                                <div class="dashboard-chart-center">
                                    <span class="text-xl font-bold text-gray-800" id="progressFinalizadaCountTotal">0</span>
                                    <span class="text-xs text-gray-500">Total</span>
                                </div>
                            </div>
                            <div class="dashboard-stats-list mt-3 space-y-1 text-sm">
                                <p class="flex justify-between text-blue-600 items-center">
                                    <span class="flex items-center">üü¶ Finalizada (Sim):</span>
                                    <span><span id="progressFinalizadaPercentSim">0.00</span>% (<span id="progressFinalizadaCountSim">0</span>)</span>
                                </p>
                                <p class="flex justify-between text-gray-500 items-center">
                                    <span class="flex items-center">‚ö™ N√£o Finalizada:</span>
                                    <span><span id="progressFinalizadaPercentNao">0.00</span>%</span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-lg border border-blue-200">
                        <h3 class="text-lg font-bold text-gray-700 mb-4 text-center">Progresso Plotagem</h3>
                        <div class="dashboard-card-content w-full">
                            <div class="dashboard-chart-area">
                                <canvas id="progressPlotagemChart"></canvas>
                                <div class="dashboard-chart-center">
                                    <span class="text-xl font-bold text-gray-800" id="progressPlotagemCountTotal">0</span>
                                    <span class="text-xs text-gray-500">Total</span>
                                </div>
                            </div>
                            <div class="dashboard-stats-list mt-3 space-y-1 text-sm">
                                <p class="flex justify-between text-green-600 items-center">
                                    <span class="flex items-center">‚úÖ Realizado:</span>
                                    <span><span id="progressPlotagemPercentRealizado">0.00</span>% (<span id="progressPlotagemCountRealizado">0</span>)</span>
                                </p>
                                <p class="flex justify-between text-yellow-600 items-center">
                                    <span class="flex items-center">üü° Aguardando:</span>
                                    <span><span id="progressPlotagemPercentAguardando">0.00</span>%</span>
                                </p>
                                <p class="flex justify-between text-gray-700 items-center">
                                    <span class="flex items-center">‚ö´ Pendente:</span>
                                    <span><span id="progressPlotagemPercentPendente">0.00</span>%</span>
                                </p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div id="tabCalendarioContent" class="hidden">
                <h2 class="text-2xl font-bold text-indigo-700 mb-6">Calend√°rio de Planejamento</h2>
                <div class="mb-4 text-sm text-gray-600">
                    <p>Visualiza√ß√£o do planejamento das unidades com base nas datas de in√≠cio e fim.</p>
                </div>
                <div id="calendarioView" class="overflow-x-auto">
                    <!-- O calend√°rio ser√° renderizado aqui -->
                </div>
            </div>
        </div>

    </div>

    <script>
        const STORAGE = 'tabela_operacional_v4';
        let progressTreinamentoChartInstance = null;
        let progressAcompanhamentoChartInstance = null;
        let progressFinalizadaChartInstance = null;
        let progressPlotagemChartInstance = null;

        const filterTreinamentoEl = document.getElementById('filterTreinamento');
        const filterRespEl = document.getElementById('filterResp');
        const filterFinalizadaEl = document.getElementById('filterFinalizada');
        const filterPlotagemElContainer = document.createElement('div');
        const clearFiltersBtn = document.getElementById('clearFilters');

        let columns = [
          { key: 'unidade', label: 'Unidade', type: 'select', width: 80, options: 'Centro de Sa√∫de Moacyr Santos, Cl√≠nica do Idoso, UPA Barra, HPMS - Hospital Serra, Unidade Mista Sana, Cl√≠nica do Autista, Casa da Crian√ßa e do Adolescente, UBS Novo Cavaleiros, ESF Aroeira, Pronto Socorro Imbetiba, UPA Lagomar, ESF Bosque Azul, ESF Malvinas AC, UBS Lagomar, ESF Glic√©rio, Pronto Socorro Aeroporto, Unidade Mista C√≥rrego do Ouro' },
          { key: 'tipo', label: 'Tipo de Unidade', type: 'select', width: 90, options: 'UBS,UPA,Hospital' },
          { key: 'dtinicio', label: 'Data In√≠cio', type: 'date', width: 120 },
          { key: 'dtfim', label: 'Data Fim', type: 'date', width: 120 },
          { key: 'tempo', label: 'Tempo (Dias)', type: 'display', width: 70 },
          { key: 'treinamento', label: 'Treinamento', type: 'select', width: 40, options: 'Ok,Pendente,Em Andamento' },
          { key: 'resp', label: 'Respons√°veis', type: 'select', width: 100, options: 'Alan,Marcelo,Maclaud,Aline,Rachel,Callmed' },
          { key: 'acompanhamento', label: 'Acompanhamento', type: 'select', width: 10, options: 'Realizado, N√£o Realizado' },
          { key: 'finalizada', label: 'FINALIZADA', type: 'select', width: 40, options: 'Sim ,N√£o' },
          { key: 'plotagem', label: 'Plotagem', type: 'select', width: 50, options: 'Realizado, Aguardando, Pendente' },
          { key: 'acoes', label: 'A√ß√µes', type: 'actions', width: 80 }
        ];

        let rows = JSON.parse(localStorage.getItem(STORAGE) || '[]');
        if (!rows.length) {
          rows = [
              { unidade: 'UPA Barra', tipo: 'UPA', dtinicio: '2025-10-01', dtfim: '2025-10-15', treinamento: 'Ok', resp: 'Alan', acompanhamento: 'Realizado', finalizada: 'Sim', plotagem: 'Realizado' },
              { unidade: 'UBS Novo Cavaleiros', tipo: 'UBS', dtinicio: '2025-10-10', dtfim: '', treinamento: 'Em Andamento', resp: 'Marcelo', acompanhamento: 'N√£o Realizado', finalizada: 'N√£o', plotagem: 'Aguardando' },
              { unidade: 'HPMS - Hospital Serra', tipo: 'Hospital', dtinicio: '2025-11-01', dtfim: '2025-11-03', treinamento: 'Pendente', resp: 'Callmed', acompanhamento: 'Realizado', finalizada: 'N√£o', plotagem: 'Pendente' },
          ];
          persist();
        }

        function persist() { localStorage.setItem(STORAGE, JSON.stringify(rows)); }
        function tdBase(w) { const td = document.createElement('td'); td.className = 'border-t'; td.style.minWidth = w + 'px'; return td; }

        function calculateTime(row) {
            if (row.dtinicio && row.dtfim) {
                const start = new Date(row.dtinicio);
                const end = new Date(row.dtfim);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                row.tempo = diffDays + 1;
            } else {
                row.tempo = '';
            }
        }

        function sortRowsByDate() {
            rows.sort((a, b) => {
                const dateA = a.dtinicio ? new Date(a.dtinicio) : null;
                const dateB = b.dtinicio ? new Date(b.dtinicio) : null;
                if (dateA && dateB) return dateA - dateB;
                if (dateA && !dateB) return -1;
                if (!dateA && dateB) return 1;
                return 0;
            });
        }

        function renderHead() {
          const tr = document.getElementById('thead');
          tr.innerHTML = '';
          columns.forEach(c => {
            const th = document.createElement('th');
            th.textContent = c.label;
            th.className = 'p-2 text-left font-semibold text-center';
            th.style.minWidth = (c.width || 140) + 'px';
            tr.appendChild(th);
          });
        }

        function applyFilters() {
            const filterTreinamento = filterTreinamentoEl.value;
            const filterResp = filterRespEl.value;
            const filterFinalizada = filterFinalizadaEl.value;
            const filterPlotagemElSelect = filterPlotagemElContainer.querySelector('select');
            const filterPlotagem = filterPlotagemElSelect ? filterPlotagemElSelect.value : '';

            let filteredRows = rows;

            if (filterTreinamento) {
                filteredRows = filteredRows.filter(row => row.treinamento === filterTreinamento);
            }
            if (filterResp) {
                filteredRows = filteredRows.filter(row => row.resp === filterResp);
            }
            if (filterFinalizada) {
                filteredRows = filteredRows.filter(row => row.finalizada === filterFinalizada);
            }
            if (filterPlotagem) {
                filteredRows = filteredRows.filter(row => row.plotagem === filterPlotagem);
            }
            return filteredRows;
        }

        function renderRows() {
          const tb = document.getElementById('tbody');
          tb.innerHTML = '';
          sortRowsByDate();
          const rowsToRender = applyFilters();

          rowsToRender.forEach((row, i) => {
            calculateTime(row);
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';

            columns.forEach(col => {
              const td = tdBase(col.width);
              td.classList.add('text-center');

              if (col.type === 'date') {
                const inp = document.createElement('input');
                inp.type = 'date';
                inp.className = 'px-2 py-1 border rounded-lg w-full';
                inp.value = row[col.key] || '';
                inp.oninput = () => {
                    row[col.key] = inp.value;
                    calculateTime(row);
                    persist();
                    renderRows();
                };
                td.appendChild(inp);
              } else if (col.type === 'display') {
                const span = document.createElement('span');
                span.textContent = row[col.key] || '-';
                span.className = 'px-2 py-1 block w-full font-semibold';
                td.appendChild(span);

              } else if (col.type === 'select') {
                const sel = document.createElement('select');
                sel.className = 'px-2 py-1 border rounded-lg bg-white w-full';
                (col.options || '').split(',').map(s => s.trim()).filter(Boolean).forEach(o => {
                  const op = document.createElement('option');
                  op.value = o;
                  op.textContent = o;
                  sel.appendChild(op);
                });
                sel.value = row[col.key] || '';
                sel.onchange = () => { row[col.key] = sel.value; persist(); renderRows(); };
                sel.classList.add('select-mini');
                td.appendChild(sel);
              } else if (col.type === 'actions') {
                const btn = document.createElement('button');
                btn.innerHTML = 'üóëÔ∏è';
                btn.title = 'Excluir linha';
                btn.className = 'px-2 py-1 rounded-lg border hover:bg-red-50 hover:text-red-600';

                btn.onclick = () => {
                  const senha = prompt("Digite a senha para excluir esta linha:");
                  if (senha === "1") {
                    if (confirm('Tem certeza que deseja excluir esta linha?')) {
                      const originalIndex = rows.findIndex(r => r === row);
                      if (originalIndex !== -1) {
                          rows.splice(originalIndex, 1);
                          persist();
                          renderRows();
                      }
                    }
                  } else {
                    alert("Senha incorreta!");
                  }
                };
                td.appendChild(btn);
              } else { // Trata 'text' e outros como input simples
                const inp = document.createElement('input');
                inp.className = 'px-2 py-1 border rounded-lg w-full';
                inp.value = row[col.key] || '';
                inp.oninput = () => { row[col.key] = inp.value; persist(); renderRows(); };
                td.appendChild(inp);
              }

              tr.appendChild(td);
            });

            tb.appendChild(tr);
          });

          updateDashboardData();
        }

        function populateFilterOptions() {
            const selectElements = [filterTreinamentoEl, filterRespEl, filterFinalizadaEl];
            selectElements.forEach(select => {
                select.innerHTML = '<option value="">Todos</option>';
            });

            filterPlotagemElContainer.className = 'filter-plotagem-container';
            filterPlotagemElContainer.innerHTML = `
                <label for="filterPlotagem" class="text-sm block">Plotagem:</label>
                <select id="filterPlotagem" class="select-mini border rounded-lg">
                    <option value="">Todos</option>
                </select>
            `;
            const filterPlotagemElSelect = filterPlotagemElContainer.querySelector('select');


            columns.forEach(col => {
                if (col.type === 'select') {
                    const targetEl = document.getElementById(`filter${col.key.charAt(0).toUpperCase() + col.key.slice(1)}`) || (col.key === 'plotagem' ? filterPlotagemElSelect : null);

                    if (targetEl) {
                        const options = col.options.split(',').map(s => s.trim()).filter(Boolean);
                        options.forEach(option => {
                            const op = document.createElement('option');
                            op.value = option;
                            op.textContent = option;
                            targetEl.appendChild(op);
                        });
                    }
                }
            });

            const filtersContainer = document.querySelector('.flex-wrap.gap-4.mb-3');
            const clearFiltersButton = document.getElementById('clearFilters');
            filtersContainer.insertBefore(filterPlotagemElContainer, clearFiltersButton);


            filterTreinamentoEl.onchange = renderRows;
            filterRespEl.onchange = renderRows;
            filterFinalizadaEl.onchange = renderRows;
            filterPlotagemElSelect.onchange = renderRows;


            clearFiltersBtn.onclick = () => {
                filterTreinamentoEl.value = '';
                filterRespEl.value = '';
                filterFinalizadaEl.value = '';
                filterPlotagemElSelect.value = '';
                renderRows();
            };
        }

        // NOVO: Fun√ß√£o para atualizar o novo gr√°fico de Plotagem
        function updateProgressPlotagemChart(realizadoCount, aguardandoCount, pendenteCount) {
            const ctx = document.getElementById('progressPlotagemChart').getContext('2d');

            if (progressPlotagemChartInstance) {
                progressPlotagemChartInstance.destroy();
            }

            progressPlotagemChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Realizado', 'Aguardando', 'Pendente'],
                    datasets: [{
                        data: [realizadoCount, aguardandoCount, pendenteCount],
                        backgroundColor: ['#10B981', '#F59E0B', '#6B7280'],
                        hoverBackgroundColor: ['#059669', '#D97706', '#4B5563'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '80%',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    return `${label}: ${value} linhas`;
                                }
                            }
                        }
                    }
                }
            });
        }


        function updateDashboardData() {
            const total = rows.length;

            const treinamentoOk = rows.filter(row => row.treinamento === "Ok").length;
            const treinamentoPendente = rows.filter(row => row.treinamento === "Pendente").length;
            const treinamentoAndamento = rows.filter(row => row.treinamento === "Em Andamento").length;

            const percentualOk = total === 0 ? 0 : (treinamentoOk / total) * 100;
            const percentualPendente = total === 0 ? 0 : (treinamentoPendente / total) * 100;
            const percentualAndamento = total === 0 ? 0 : (treinamentoAndamento / total) * 100;

            const acompanhamentoRealizado = rows.filter(row => row.acompanhamento === "Realizado").length;
            const acompanhamentoNaoRealizado = rows.filter(row => row.acompanhamento === "N√£o Realizado").length;
            const percentualRealizado = total === 0 ? 0 : (acompanhamentoRealizado / total) * 100;
            const percentualNaoRealizado = total === 0 ? 0 : (acompanhamentoNaoRealizado / total) * 100;

            const finalizadaSim = rows.filter(row => row.finalizada === "Sim").length;
            const finalizadaNao = rows.filter(row => row.finalizada === "N√£o").length;
            const percentualSim = total === 0 ? 0 : (finalizadaSim / total) * 100;
            const percentualNao = total === 0 ? 0 : (finalizadaNao / total) * 100;

            const plotagemRealizado = rows.filter(row => row.plotagem === "Realizado").length;
            const plotagemAguardando = rows.filter(row => row.plotagem === "Aguardando").length;
            const plotagemPendente = rows.filter(row => row.plotagem === "Pendente").length;

            const percentualPlotagemRealizado = total === 0 ? 0 : (plotagemRealizado / total) * 100;
            const percentualPlotagemAguardando = total === 0 ? 0 : (plotagemAguardando / total) * 100;
            const percentualPlotagemPendente = total === 0 ? 0 : (plotagemPendente / total) * 100;


            // Atualiza Treinamento
            document.getElementById("progressTreinamentoPercentOk").textContent = percentualOk.toFixed(2);
            document.getElementById("progressTreinamentoPercentPendente").textContent = percentualPendente.toFixed(2);
            document.getElementById("progressTreinamentoPercentAndamento").textContent = percentualAndamento.toFixed(2);
            document.getElementById("progressTreinamentoCountOk").textContent = treinamentoOk;
            document.getElementById("progressTreinamentoCountTotal").textContent = total;

            // Atualiza Acompanhamento
            document.getElementById("progressAcompanhamentoPercentRealizado").textContent = percentualRealizado.toFixed(2);
            document.getElementById("progressAcompanhamentoPercentNaoRealizado").textContent = percentualNaoRealizado.toFixed(2);
            document.getElementById("progressAcompanhamentoCountRealizado").textContent = acompanhamentoRealizado;
            document.getElementById("progressAcompanhamentoCountTotal").textContent = total;

            // Atualiza Finalizada
            document.getElementById("progressFinalizadaPercentSim").textContent = percentualSim.toFixed(2);
            document.getElementById("progressFinalizadaPercentNao").textContent = percentualNao.toFixed(2);
            document.getElementById("progressFinalizadaCountSim").textContent = finalizadaSim;
            document.getElementById("progressFinalizadaCountTotal").textContent = total;

            // Atualiza contagens e percentuais de Plotagem
            document.getElementById("progressPlotagemPercentRealizado").textContent = percentualPlotagemRealizado.toFixed(2);
            document.getElementById("progressPlotagemPercentAguardando").textContent = percentualPlotagemAguardando.toFixed(2);
            document.getElementById("progressPlotagemPercentPendente").textContent = percentualPlotagemPendente.toFixed(2);
            document.getElementById("progressPlotagemCountRealizado").textContent = plotagemRealizado;
            document.getElementById("progressPlotagemCountTotal").textContent = total;

            // Chamadas de renderiza√ß√£o (com a corre√ß√£o anterior)
            updateProgressTreinamentoChart(treinamentoOk, treinamentoPendente, treinamentoAndamento);
            updateProgressAcompanhamentoChart(acompanhamentoRealizado, acompanhamentoNaoRealizado);
            updateProgressFinalizadaChart(finalizadaSim, finalizadaNao);
            updateProgressPlotagemChart(plotagemRealizado, plotagemAguardando, plotagemPendente);

        }

        // 1. Gr√°fico ROSCA (Progresso Treinamento OK/Pendente/Em Andamento)
        function updateProgressTreinamentoChart(okCount, pendingCount, andamentoCount) {
            const ctx = document.getElementById('progressTreinamentoChart').getContext('2d');

            if (progressTreinamentoChartInstance) {
                progressTreinamentoChartInstance.destroy();
            }

            progressTreinamentoChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Conclu√≠do (Ok)', 'Pendente', 'Em Andamento'],
                    datasets: [{
                        data: [okCount, pendingCount, andamentoCount],
                        backgroundColor: ['#10B981', '#FCD34D', '#3B82F6'],
                        hoverBackgroundColor: ['#059669', '#FBBF24', '#2563EB'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '80%',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    return `${label}: ${value} linhas`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 2. Gr√°fico ROSCA (Progresso Acompanhamento Realizado/N√£o Realizado)
        function updateProgressAcompanhamentoChart(realizadoCount, naoRealizadoCount) {
            const ctx = document.getElementById('progressAcompanhamentoChart').getContext('2d');

            if (progressAcompanhamentoChartInstance) {
                progressAcompanhamentoChartInstance.destroy();
            }

            progressAcompanhamentoChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Realizado', 'N√£o Realizado'],
                    datasets: [{
                        data: [realizadoCount, naoRealizadoCount],
                        backgroundColor: ['#F59E0B', '#EF4444'],
                        hoverBackgroundColor: ['#D97706', '#DC2626'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '80%',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    return `${label}: ${value} linhas`;
                                }
                            }
                        }
                    }
                }
            });
        }


        // 3. Gr√°fico ROSCA (Progresso FINALIZADA SIM/N√ÉO)
        function updateProgressFinalizadaChart(simCount, naoCount) {
            const ctx = document.getElementById('progressFinalizadaChart').getContext('2d');

            if (progressFinalizadaChartInstance) {
                progressFinalizadaChartInstance.destroy();
            }

            progressFinalizadaChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Finalizada (Sim)', 'N√£o Finalizada'],
                    datasets: [{
                        data: [simCount, naoCount],
                        backgroundColor: ['#3B82F6', '#6B7280'],
                        hoverBackgroundColor: ['#2563EB', '#4B5563'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '80%',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    return `${label}: ${value} linhas`;
                                }
                            }
                        }
                    }
                }
            });
        }


        // =======================================================
        // FUN√á√ïES DE EXPORTA√á√ÉO E CONTROLE (ID√äNTICAS AO ORIGINAL)
        // =======================================================

        function createDownloadLink(content, type, extension) {
            const BOM = "\uFEFF";
            const blob = new Blob([BOM, content], { type: type });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');

            link.setAttribute('href', url);
            link.setAttribute('download', `tabela_operacional_${new Date().toISOString().slice(0, 10)}.${extension}`);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function prepareData(separator) {
            const rowsToExport = applyFilters();
            rowsToExport.forEach(calculateTime);

            const exportableColumns = columns.filter(c => c.key !== 'acoes');

            const headers = exportableColumns.map(c => c.label).join(separator);

            const csvRows = rowsToExport.map(row =>
                exportableColumns.map(col => {
                    let value = row[col.key] || '';
                    value = String(value).replace(/"/g, '""');
                    if (value.includes(separator) || value.includes('"') || value.includes('\n')) {
                        value = `"${value}"`;
                    }
                    return value;
                }).join(separator)
            );

            return [headers, ...csvRows].join('\n');
        }

        function exportToCsv() {
            const content = prepareData(',');
            createDownloadLink(content, 'text/csv;charset=utf-8;', 'csv');
        }

        function exportToExcel() {
            const content = prepareData(';');
            createDownloadLink(content, 'application/vnd.ms-excel;charset=utf-8;', 'xls');
        }

        function exportToPDF() {
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                 alert('A biblioteca jsPDF n√£o foi carregada. Verifique sua conex√£o e as tags <script> no <head>.');
                 return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'pt', 'a4');
            const rowsToExport = applyFilters();
            rowsToExport.forEach(calculateTime);

            const exportableColumns = columns.filter(c => c.key !== 'acoes');
            const head = [exportableColumns.map(c => c.label)];
            const body = rowsToExport.map(row =>
                exportableColumns.map(col => String(row[col.key] || ''))
            );

            doc.autoTable({
                head: head,
                body: body,
                theme: 'striped',
                startY: 50,
                styles: { fontSize: 8, cellPadding: 4, halign: 'center' },
                headStyles: { fillColor: [59, 130, 246] },
                didDrawPage: function (data) {
                    doc.setFontSize(14);
                    doc.text("Tabela de Operacional - MEEDS MACA√â", data.settings.margin.left, 30);

                    doc.setFontSize(8);
                    const pageCount = doc.internal.getNumberOfPages();
                    doc.text(`P√°gina ${data.pageNumber} de ${pageCount}`, doc.internal.pageSize.width - data.settings.margin.right, doc.internal.pageSize.height - 10);
                }
            });

            doc.save(`tabela_operacional_${new Date().toISOString().slice(0, 10)}.pdf`);
        }

        // =======================================================
        // FUN√á√ÉO DE RENDERIZA√á√ÉO DO CALEND√ÅRIO
        // =======================================================

        // Array de cores vibrantes para as unidades
        const unitColors = [
            '#FF5733', // Vermelho-Laranja
            '#33FF57', // Verde-Lima
            '#3357FF', // Azul Brilhante
            '#FF33A1', // Rosa Choque
            '#33FFF6', // Ciano
            '#FFC300', // Amarelo Ouro
            '#C70039', // Vermelho Escuro
            '#900C3F', // Borgonha
            '#581845', // Roxo Escuro
            '#008080', // Verde-Azulado
            '#FF8C00', // Laranja Escuro
            '#4B0082', // √çndigo
            '#800000', // Marrom
            '#00FF00', // Verde Puro
            '#00FFFF', // Aqua
            '#FF00FF', // Magenta
        ];

        // Fun√ß√£o para obter uma cor consistente para cada unidade
        function getColorForUnit(unitName) {
            // Simples hash para mapear o nome da unidade a um √≠ndice do array de cores
            let hash = 0;
            for (let i = 0; i < unitName.length; i++) {
                hash = unitName.charCodeAt(i) + ((hash << 5) - hash);
            }
            const index = Math.abs(hash) % unitColors.length;
            return unitColors[index];
        }

        function renderCalendar() {
            const calendarioView = document.getElementById('calendarioView');

            // Filtrar apenas linhas com datas v√°lidas
            const validRows = rows.filter(row => row.dtinicio && row.dtfim);

            if (validRows.length === 0) {
                calendarioView.innerHTML = '<div class="text-center text-gray-500 py-8">Nenhum registro com datas de in√≠cio e fim encontrado.</div>';
                return;
            }

            // Encontrar a data m√≠nima e m√°xima
            let minDate = new Date(validRows[0].dtinicio);
            let maxDate = new Date(validRows[0].dtfim);

            validRows.forEach(row => {
                const inicio = new Date(row.dtinicio);
                const fim = new Date(row.dtfim);
                if (inicio < minDate) minDate = inicio;
                if (fim > maxDate) maxDate = fim;
            });

            // Agrupar eventos por m√™s
            const monthsToRender = [];
            const currentMonth = new Date(minDate.getFullYear(), minDate.getMonth(), 1);
            const endMonth = new Date(maxDate.getFullYear(), maxDate.getMonth(), 1);

            while (currentMonth <= endMonth) {
                monthsToRender.push(new Date(currentMonth));
                currentMonth.setMonth(currentMonth.getMonth() + 1);
            }

            let html = '';

            // Renderizar cada m√™s
            monthsToRender.forEach(monthDate => {
                const year = monthDate.getFullYear();
                const month = monthDate.getMonth();
                const monthName = monthDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

                // Cabe√ßalho do m√™s
                html += '<div class="mb-8">';
                html += `<h3 class="text-xl font-bold text-indigo-700 mb-4 capitalize">${monthName}</h3>`;
                html += '<div class="calendar-month-container">';
                html += '<table class="calendar-month-table">';

                // Cabe√ßalho dos dias da semana
                html += '<thead><tr>';
                const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
                diasSemana.forEach(dia => {
                    html += `<th class="calendar-weekday-header">${dia}</th>`;
                });
                html += '</tr></thead>';

                // Corpo do calend√°rio
                html += '<tbody>';

                // Primeiro dia do m√™s e √∫ltimo dia do m√™s
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const firstDayOfWeek = firstDay.getDay(); // 0 = Domingo
                const totalDays = lastDay.getDate();

                let dayCounter = 1;
                let weekRow = 0;

                // Renderizar semanas
                while (dayCounter <= totalDays) {
                    html += '<tr class="calendar-week-row">';

                    // Renderizar 7 dias (domingo a s√°bado)
                    for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
                        // C√©lulas vazias antes do primeiro dia
                        if (weekRow === 0 && dayOfWeek < firstDayOfWeek) {
                            html += '<td class="calendar-day-cell-empty"></td>';
                        }
                        // C√©lulas vazias depois do √∫ltimo dia
                        else if (dayCounter > totalDays) {
                            html += '<td class="calendar-day-cell-empty"></td>';
                        }
                        // C√©lulas com dias v√°lidos
                        else {
                            const currentDate = new Date(year, month, dayCounter);
                            const dateStr = currentDate.toISOString().split('T')[0];

                            html += '<td class="calendar-day-cell-month">';
                            html += `<div class="calendar-day-number">${dayCounter}</div>`;
                            html += '<div class="calendar-day-events">';

                            // Verificar quais unidades t√™m eventos neste dia
                            validRows.forEach(row => {
                                if (dateStr >= row.dtinicio && dateStr <= row.dtfim) {
	                                    const unitColor = getColorForUnit(row.unidade);

	                                    // Substituir o √≠cone pelo nome da unidade
	                                    const label = row.unidade || 'Unidade Sem Nome';

	                                    html += `<div class="calendar-event-badge" style="background-color: ${unitColor}; color: white;" title="${row.unidade} - ${row.treinamento}">${label}</div>`;
                                }
                            });

                            html += '</div>';
                            html += '</td>';

                            dayCounter++;
                        }
                    }

                    html += '</tr>';
                    weekRow++;
                }

                html += '</tbody></table>';
                html += '</div>';
                html += '</div>';
            });

	            // A legenda de status foi removida, pois a cor agora representa a unidade.
	            // Se necess√°rio, uma legenda de unidades pode ser adicionada aqui.

            calendarioView.innerHTML = html;
        }

        // =======================================================
        // L√ìGICA DE ABAS E EVENTOS
        // =======================================================

        const downloadButton = document.getElementById('downloadButton');
        const downloadMenu = document.getElementById('downloadMenu');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const exportXlsBtn = document.getElementById('exportXlsBtn');
        const exportPdfBtn = document.getElementById('exportPdfBtn');

        downloadButton.onclick = (e) => {
            e.stopPropagation();
            downloadMenu.classList.toggle('hidden');
        };

        document.addEventListener('click', (e) => {
            if (downloadMenu && !downloadMenu.contains(e.target) && !downloadButton.contains(e.target)) {
                downloadMenu.classList.add('hidden');
            }
        });

        exportCsvBtn.onclick = (e) => { e.preventDefault(); exportToCsv(); downloadMenu.classList.add('hidden'); };
        exportXlsBtn.onclick = (e) => { e.preventDefault(); exportToExcel(); downloadMenu.classList.add('hidden'); };
        exportPdfBtn.onclick = (e) => { e.preventDefault(); exportToPDF(); downloadMenu.classList.add('hidden'); };

        const tabPrincipal = document.getElementById('tabPrincipal');
        const tabDashboard = document.getElementById('tabDashboard');
        const tabCalendario = document.getElementById('tabCalendario');
        const tabPrincipalContent = document.getElementById('tabPrincipalContent');
        const tabDashboardContent = document.getElementById('tabDashboardContent');
        const tabCalendarioContent = document.getElementById('tabCalendarioContent');

        function showTab(tabName) {
            [tabPrincipal, tabDashboard, tabCalendario].forEach(tab => {
                tab.classList.remove('bg-white', 'shadow-sm', 'font-semibold', 'text-white', 'bg-indigo-600', 'shadow-md');
                tab.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
            });

            [tabPrincipalContent, tabDashboardContent, tabCalendarioContent].forEach(content => {
                content.classList.add('hidden');
            });

            if (tabName === 'principal') {
                tabPrincipalContent.classList.remove('hidden');
                tabPrincipal.classList.add('bg-white', 'shadow-sm', 'font-semibold', 'text-gray-700');
                tabPrincipal.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                renderRows();
            } else if (tabName === 'dashboard') {
                tabDashboardContent.classList.remove('hidden');
                tabDashboard.classList.add('bg-indigo-600', 'shadow-md', 'text-white');
                tabDashboard.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                updateDashboardData();
            } else if (tabName === 'calendario') {
                tabCalendarioContent.classList.remove('hidden');
                tabCalendario.classList.add('bg-white', 'shadow-sm', 'font-semibold', 'text-gray-700');
                tabCalendario.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                renderCalendar();
            }
        }

        tabPrincipal.onclick = () => showTab('principal');
        tabDashboard.onclick = () => showTab('dashboard');
        tabCalendario.onclick = () => showTab('calendario');

        document.getElementById('addRow').onclick = () => {
            rows.push({ plotagem: 'Aguardando' });
            persist();
            renderRows();
        };

        document.getElementById('clr').onclick = () => {
          const senha = prompt("üö® Digite a senha para APAGAR TODOS os dados:");
          if (senha === "1") {
            if (confirm('‚ö†Ô∏è ATEN√á√ÉO: Tem certeza que deseja APAGAR TODOS os dados da tabela? Esta a√ß√£o √© IRREVERS√çVEL!')) {
              rows = [];
              persist();
              renderRows();
              showTab('principal');
              alert("‚úÖ Todos os dados foram apagados com sucesso!");
            }
          } else if (senha !== null) {
            alert("‚ùå Senha incorreta! Os dados n√£o foram apagados.");
          }
        };

        /* ===== Start ===== */
        populateFilterOptions();
        renderHead();
        showTab('principal');
    </script>
</body>
</html>

